{"docker":[{"name":"FROM","lineno":1,"args":"amazoncorretto:8","raw":"FROM amazoncorretto:8"},{"name":"ENV","lineno":3,"args":{"CATALINA_HOME":"/usr/local/tomcat"},"raw":"ENV CATALINA_HOME /usr/local/tomcat"},{"name":"ENV","lineno":4,"args":{"PATH":"$CATALINA_HOME/bin:$PATH"},"raw":"ENV PATH $CATALINA_HOME/bin:$PATH"},{"name":"RUN","lineno":5,"args":"mkdir -p \"$CATALINA_HOME\"","raw":"RUN mkdir -p \"$CATALINA_HOME\""},{"name":"WORKDIR","lineno":6,"args":"$CATALINA_HOME","raw":"WORKDIR $CATALINA_HOME"},{"name":"ENV","lineno":9,"args":{"TOMCAT_NATIVE_LIBDIR":"$CATALINA_HOME/native-jni-lib"},"raw":"ENV TOMCAT_NATIVE_LIBDIR $CATALINA_HOME/native-jni-lib"},{"name":"ENV","lineno":10,"args":{"LD_LIBRARY_PATH":"${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$TOMCAT_NATIVE_LIBDIR"},"raw":"ENV LD_LIBRARY_PATH ${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$TOMCAT_NATIVE_LIBDIR"},{"name":"ENV","lineno":14,"args":{"GPG_KEYS":"05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23"},"raw":"ENV GPG_KEYS 05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23"},{"name":"ENV","lineno":16,"args":{"TOMCAT_MAJOR":"9"},"raw":"ENV TOMCAT_MAJOR 9"},{"name":"ENV","lineno":17,"args":{"TOMCAT_VERSION":"9.0.33"},"raw":"ENV TOMCAT_VERSION 9.0.33"},{"name":"ENV","lineno":18,"args":{"TOMCAT_SHA512":"caaed46e47075aff5cb97dfef0abe7fab7897691f2e81a2660c3c59f86df44d5894a5136188808e48685919ca031acd541da97c4aba2512e0937455972004a2b"},"raw":"ENV TOMCAT_SHA512 caaed46e47075aff5cb97dfef0abe7fab7897691f2e81a2660c3c59f86df44d5894a5136188808e48685919ca031acd541da97c4aba2512e0937455972004a2b"},{"name":"RUN","lineno":22,"args":"set -eux; \t# http://yum.baseurl.org/wiki/YumDB.html","raw":"RUN set -eux; \t# http://yum.baseurl.org/wiki/YumDB.html"},{"name":"IF","lineno":28,"args":"! command -v yumdb > /dev/null; then \t\tyum install -y yum-utils; \t\tyumdb set reason dep yum-utils; \tfi; \tif [ -f /etc/oracle-release ]; then # TODO there's an odd bug on Oracle Linux where installing \"cpp\" (which gets pulled in as a dependency of \"gcc\") and then marking it as automatically-installed will result in the \"filesystem\" package being removed during \"yum autoremove\" (which then fails), so we set it as manually-installed to compensate","raw":"if ! command -v yumdb > /dev/null; then \t\tyum install -y yum-utils; \t\tyumdb set reason dep yum-utils; \tfi; \tif [ -f /etc/oracle-release ]; then # TODO there's an odd bug on Oracle Linux where installing \"cpp\" (which gets pulled in as a dependency of \"gcc\") and then marking it as automatically-installed will result in the \"filesystem\" package being removed during \"yum autoremove\" (which then fails), so we set it as manually-installed to compensate"},{"name":"YUMDB","lineno":31,"args":"set reason user filesystem; \tfi; # a helper function to \"yum install\" things, but only if they aren't installed (and to set their \"reason\" to \"dep\" so \"yum autoremove\" can purge them for us)","raw":"yumdb set reason user filesystem; \tfi; # a helper function to \"yum install\" things, but only if they aren't installed (and to set their \"reason\" to \"dep\" so \"yum autoremove\" can purge them for us)"},{"name":"_YUM_INSTALL_TEMPORARY()","lineno":53,"args":"{ ( set -eu +x; \t\tlocal pkg todo=''; \t\tfor pkg; do \t\t\tif ! rpm --query \"$pkg\" > /dev/null 2>&1; then \t\t\t\ttodo=\"$todo $pkg\"; \t\t\tfi; \t\tdone; \t\tif [ -n \"$todo\" ]; then \t\t\tset -x; \t\t\tyum install -y $todo; \t\t\tyumdb set reason dep $todo; \t\tfi; \t) }; \t_yum_install_temporary gzip tar; \t\tddist() { \t\tlocal f=\"$1\"; shift; \t\tlocal distFile=\"$1\"; shift; \t\tlocal success=; \t\tlocal distUrl=; \t\tfor distUrl in # https://issues.apache.org/jira/browse/INFRA-8753","raw":"_yum_install_temporary() { ( set -eu +x; \t\tlocal pkg todo=''; \t\tfor pkg; do \t\t\tif ! rpm --query \"$pkg\" > /dev/null 2>&1; then \t\t\t\ttodo=\"$todo $pkg\"; \t\t\tfi; \t\tdone; \t\tif [ -n \"$todo\" ]; then \t\t\tset -x; \t\t\tyum install -y $todo; \t\t\tyumdb set reason dep $todo; \t\tfi; \t) }; \t_yum_install_temporary gzip tar; \t\tddist() { \t\tlocal f=\"$1\"; shift; \t\tlocal distFile=\"$1\"; shift; \t\tlocal success=; \t\tlocal distUrl=; \t\tfor distUrl in # https://issues.apache.org/jira/browse/INFRA-8753"},{"name":"FOCUSEDCOMMENTID=14735394#COMMENT-14735394","lineno":54,"args":"","raw":"focusedCommentId=14735394#comment-14735394"},{"name":"'HTTPS://WWW.APACHE.ORG/DYN/CLOSER.CGI","lineno":55,"args":"","raw":"'https://www.apache.org/dyn/closer.cgi"},{"name":"ACTION=DOWNLOAD&FILENAME='","lineno":57,"args":"# if the version is outdated (or we're grabbing the .asc file), we might have to pull from the dist/archive :/","raw":"action=download&filename=' # if the version is outdated (or we're grabbing the .asc file), we might have to pull from the dist/archive :/"},{"name":"HTTPS://WWW-US.APACHE.ORG/DIST/","lineno":84,"args":"https://www.apache.org/dist/ \t\t\thttps://archive.apache.org/dist/ \t\t; do \t\t\tif curl -fL -o \"$f\" \"$distUrl$distFile\" && [ -s \"$f\" ]; then \t\t\t\tsuccess=1; \t\t\t\tbreak; \t\t\tfi; \t\tdone; \t\t[ -n \"$success\" ]; \t}; \t\tddist 'tomcat.tar.gz' \"tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz\"; \techo \"$TOMCAT_SHA512 *tomcat.tar.gz\" | sha512sum --strict --check -; \tddist 'tomcat.tar.gz.asc' \"tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc\"; \texport GNUPGHOME=\"$(mktemp -d)\"; \tfor key in $GPG_KEYS; do \t\tgpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\"; \tdone; \tgpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz; \ttar -xf tomcat.tar.gz --strip-components=1; \trm bin/*.bat; \trm tomcat.tar.gz*; \tcommand -v gpgconf && gpgconf --kill all || :; \trm -rf \"$GNUPGHOME\"; \t# https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Default_web_applications","raw":"https://www-us.apache.org/dist/ \t\t\thttps://www.apache.org/dist/ \t\t\thttps://archive.apache.org/dist/ \t\t; do \t\t\tif curl -fL -o \"$f\" \"$distUrl$distFile\" && [ -s \"$f\" ]; then \t\t\t\tsuccess=1; \t\t\t\tbreak; \t\t\tfi; \t\tdone; \t\t[ -n \"$success\" ]; \t}; \t\tddist 'tomcat.tar.gz' \"tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz\"; \techo \"$TOMCAT_SHA512 *tomcat.tar.gz\" | sha512sum --strict --check -; \tddist 'tomcat.tar.gz.asc' \"tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc\"; \texport GNUPGHOME=\"$(mktemp -d)\"; \tfor key in $GPG_KEYS; do \t\tgpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\"; \tdone; \tgpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz; \ttar -xf tomcat.tar.gz --strip-components=1; \trm bin/*.bat; \trm tomcat.tar.gz*; \tcommand -v gpgconf && gpgconf --kill all || :; \trm -rf \"$GNUPGHOME\"; \t# https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Default_web_applications"},{"name":"MV","lineno":87,"args":"webapps webapps.dist; \tmkdir webapps; # we don't delete them completely because they're frankly a pain to get back for users who do want them, and they're generally tiny (~7MB)","raw":"mv webapps webapps.dist; \tmkdir webapps; # we don't delete them completely because they're frankly a pain to get back for users who do want them, and they're generally tiny (~7MB)"},{"name":"NATIVEBUILDDIR=\"$(MKTEMP","lineno":113,"args":"-d)\"; \ttar -xf bin/tomcat-native.tar.gz -C \"$nativeBuildDir\" --strip-components=1; \t_yum_install_temporary \t\tapr-devel \t\tgcc \t\tmake \t\topenssl-devel \t; \t( \t\texport CATALINA_HOME=\"$PWD\"; \t\tcd \"$nativeBuildDir/native\"; \t\taprConfig=\"$(command -v apr-1-config)\"; \t\t./configure \t\t\t--libdir=\"$TOMCAT_NATIVE_LIBDIR\" \t\t\t--prefix=\"$CATALINA_HOME\" \t\t\t--with-apr=\"$aprConfig\" \t\t\t--with-java-home=\"$JAVA_HOME\" \t\t\t--with-ssl=yes; \t\tmake -j \"$(nproc)\"; \t\tmake install; \t); \trm -rf \"$nativeBuildDir\"; \trm bin/tomcat-native.tar.gz; \t# mark any explicit dependencies as manually installed","raw":"nativeBuildDir=\"$(mktemp -d)\"; \ttar -xf bin/tomcat-native.tar.gz -C \"$nativeBuildDir\" --strip-components=1; \t_yum_install_temporary \t\tapr-devel \t\tgcc \t\tmake \t\topenssl-devel \t; \t( \t\texport CATALINA_HOME=\"$PWD\"; \t\tcd \"$nativeBuildDir/native\"; \t\taprConfig=\"$(command -v apr-1-config)\"; \t\t./configure \t\t\t--libdir=\"$TOMCAT_NATIVE_LIBDIR\" \t\t\t--prefix=\"$CATALINA_HOME\" \t\t\t--with-apr=\"$aprConfig\" \t\t\t--with-java-home=\"$JAVA_HOME\" \t\t\t--with-ssl=yes; \t\tmake -j \"$(nproc)\"; \t\tmake install; \t); \trm -rf \"$nativeBuildDir\"; \trm bin/tomcat-native.tar.gz; \t# mark any explicit dependencies as manually installed"},{"name":"DEPS=\"$(","lineno":123,"args":"find \"$TOMCAT_NATIVE_LIBDIR\" -type f -executable -exec ldd '{}' ';' \t\t\t| awk '/=>/ && $(NF-1) != \"=>\" { print $(NF-1) }' \t\t\t| sort -u \t\t\t| xargs -r rpm --query --whatprovides \t\t\t| sort -u \t)\"; \t[ -z \"$deps\" ] || yumdb set reason user $deps; \t# clean up anything added temporarily and not later marked as necessary","raw":"deps=\"$( \t\tfind \"$TOMCAT_NATIVE_LIBDIR\" -type f -executable -exec ldd '{}' ';' \t\t\t| awk '/=>/ && $(NF-1) != \"=>\" { print $(NF-1) }' \t\t\t| sort -u \t\t\t| xargs -r rpm --query --whatprovides \t\t\t| sort -u \t)\"; \t[ -z \"$deps\" ] || yumdb set reason user $deps; \t# clean up anything added temporarily and not later marked as necessary"},{"name":"YUM","lineno":128,"args":"autoremove -y; \tyum clean all; \trm -rf /var/cache/yum; \t# sh removes env vars it doesn't support (ones with periods)","raw":"yum autoremove -y; \tyum clean all; \trm -rf /var/cache/yum; \t# sh removes env vars it doesn't support (ones with periods)"},{"name":"FIND","lineno":132,"args":"./bin/ -name '*.sh' -exec sed -ri 's|^#!/bin/sh$|#!/usr/bin/env bash|' '{}' +; \t# fix permissions (especially for running as non-root)","raw":"find ./bin/ -name '*.sh' -exec sed -ri 's|^#!/bin/sh$|#!/usr/bin/env bash|' '{}' +; \t# fix permissions (especially for running as non-root)"},{"name":"CHMOD","lineno":135,"args":"-R +rX .; \tchmod 777 logs temp work","raw":"chmod -R +rX .; \tchmod 777 logs temp work"},{"name":"RUN","lineno":145,"args":"set -e \t&& nativeLines=\"$(catalina.sh configtest 2>&1)\" \t&& nativeLines=\"$(echo \"$nativeLines\" | grep 'Apache Tomcat Native')\" \t&& nativeLines=\"$(echo \"$nativeLines\" | sort -u)\" \t&& if ! echo \"$nativeLines\" | grep 'INFO: Loaded APR based Apache Tomcat Native library' >&2; then \t\techo >&2 \"$nativeLines\"; \t\texit 1; \tfi","raw":"RUN set -e \t&& nativeLines=\"$(catalina.sh configtest 2>&1)\" \t&& nativeLines=\"$(echo \"$nativeLines\" | grep 'Apache Tomcat Native')\" \t&& nativeLines=\"$(echo \"$nativeLines\" | sort -u)\" \t&& if ! echo \"$nativeLines\" | grep 'INFO: Loaded APR based Apache Tomcat Native library' >&2; then \t\techo >&2 \"$nativeLines\"; \t\texit 1; \tfi"},{"name":"EXPOSE","lineno":147,"args":["8080"],"raw":"EXPOSE 8080"},{"name":"CMD","lineno":148,"args":["catalina.sh","run"],"raw":"CMD [\"catalina.sh\", \"run\"]"}]}